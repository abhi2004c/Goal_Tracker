// backend/prisma/schema.prisma

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USER ====================
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String?
  name          String?
  avatar        String?
  provider      String?   // 'google', 'email', etc.
  providerId    String?   // Google user ID
  tokenVersion  Int       @default(0)  // For token invalidation
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  subscription  Subscription?
  projects      Project[]
  aiPlans       AIPlan[]
  
  @@map("users")
}

// ==================== SUBSCRIPTION ====================
model Subscription {
  id                   String     @id @default(cuid())
  userId               String     @unique
  
  plan                 Plan       @default(FREE)
  status               SubStatus  @default(ACTIVE)
  
  stripeCustomerId     String?
  stripeSubscriptionId String?
  
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt
  
  user                 User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("subscriptions")
}

enum Plan {
  FREE
  PREMIUM
}

enum SubStatus {
  ACTIVE
  CANCELED
  PAST_DUE
}

// ==================== PROJECT ====================
model Project {
  id          String        @id @default(cuid())
  userId      String
  
  name        String
  description String?
  color       String        @default("#6366f1")
  
  status      ProjectStatus @default(ACTIVE)
  priority    Priority      @default(MEDIUM)
  
  deadline    DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  tasks       Task[]
  
  @@index([userId])
  @@map("projects")
}

enum ProjectStatus {
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

// ==================== TASK ====================
model Task {
  id          String     @id @default(cuid())
  projectId   String
  
  title       String
  description String?
  
  status      TaskStatus @default(TODO)
  priority    Priority   @default(MEDIUM)
  
  order       Int        @default(0)
  
  dueDate     DateTime?
  completedAt DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  project     Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  logs        TaskLog[]
  
  @@index([projectId])
  @@index([status])
  @@map("tasks")
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  COMPLETED
}

// ==================== TASK LOG ====================
model TaskLog {
  id             String      @id @default(cuid())
  taskId         String
  
  action         String
  previousStatus TaskStatus?
  newStatus      TaskStatus?
  
  createdAt      DateTime    @default(now())
  
  task           Task        @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  @@index([taskId])
  @@map("task_logs")
}

// ==================== AI PLAN ====================
model AIPlan {
  id                 String   @id @default(cuid())
  userId             String
  
  goal               String
  context            Json?
  generatedTasks     Json
  
  imported           Boolean  @default(false)
  importedToProject  String?
  
  createdAt          DateTime @default(now())
  
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@map("ai_plans")
}